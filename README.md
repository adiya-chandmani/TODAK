# 토닥(TODAK) - 어린이 심리상담 AI

만 4~8세 아이를 위한 AI 심리상담가 토닥과 텔레그램을 통한 부모님과의 브릿지 시스템입니다.

## 기능

- 스페이스 바를 누르는 동안 음성 녹음
- 만 4~8세 아이에게 적합한 AI 심리상담
- 텔레그램을 통한 부모님과의 양방향 메시지 전달
- 음성을 텍스트로, 텍스트를 음성으로 변환

## 설치 방법

1. 필요한 라이브러리 설치:
```bash
pip install -r requirements.txt
```

2. 환경 변수 설정:
`.env` 파일을 생성하고 다음 내용을 추가하세요:

```
# OpenAI API 키
OPENAI_API_KEY=your_openai_api_key_here

# 텔레그램 봇 토큰 (BotFather에서 받은 토큰)
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# 부모님의 텔레그램 채팅 ID (숫자)
PARENT_CHAT_ID=your_parent_chat_id_here
```

## 텔레그램 봇 설정 방법

1. 텔레그램에서 @BotFather를 찾아서 새 봇을 생성합니다.
2. 봇 토큰을 받아서 `TELEGRAM_BOT_TOKEN`에 입력합니다.
3. 부모님의 텔레그램 채팅 ID를 확인합니다:
   - 봇과 대화를 시작한 후, 브라우저에서 `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`를 방문
   - 응답에서 `chat.id` 값을 찾아서 `PARENT_CHAT_ID`에 입력

## 사용 방법

1. 프로그램 실행:
```bash
python main.py
```

2. 아이가 =키를 눌러서 녹음을 시작하고, 다시 =키를 눌러서 녹음을 끝냅니다.
3. 토닥이 응답을 음성으로 들려줍니다.
4. 아이가 "엄마한테 전해줘"라고 말하면 부모님에게 메시지가 전달됩니다.
5. 부모님이 텔레그램으로 메시지를 보내면 토닥이 아이에게 읽어줍니다.

## 텔레그램 봇 명령어

### `/time` - 일일 사용시간 설정
- **사용법**: `/time`
- **기본값**: 30분
- **범위**: 5분 ~ 120분
- **설명**: 아이의 일일 사용시간을 제한합니다.

**선택 옵션:**
- 15분
- 30분  
- 45분
- 직접입력 (5분~120분)

### `/report` - 성장 리포트 조회
- **사용법**: `/report`
- **설명**: 아이의 대화 내용을 분석한 성장 리포트를 확인합니다.
- **자동 생성**: 아이가 3번 이상 대화하면 자동으로 생성됩니다.

### `/reminder` - 리마인더 설정
- **사용법**: `/reminder [할 일]`
- **설명**: 아이에게 전달할 리마인더를 설정합니다.
- **예시**: 
  - `/reminder 숙제하기`
  - `/reminder 치과 예약 시간 확인하기`
  - `/reminder clear` (리마인더 삭제)
- **자동 전달**: 아이가 토닥과 대화할 때 자동으로 전달됩니다.

### `/start` - 봇 시작
- 봇 사용법을 안내합니다.

## 성장 리포트 기능

- 아이가 토닥과 3번 이상 대화하면 자동으로 성장 리포트가 생성됩니다
- GPT가 대화 내용을 분석하여 다음 정보를 제공합니다:
  - 🎯 주요 관심사
  - 💭 감정 상태
  - 🌟 성장 포인트
  - 🤔 부모님께 드리는 조언
  - 📝 특별한 메모
- 부모님이 텔레그램에서 `/report` 명령어로 언제든지 조회 가능합니다
- 매일 자정에 대화 기록이 자동으로 리셋됩니다

## 리마인더 기능

- 부모님이 텔레그램에서 `/reminder` 명령어로 아이에게 전달할 할 일을 설정할 수 있습니다
- 설정된 리마인더는 아이가 토닥과 대화할 때 자동으로 전달됩니다
- 토닥이 자연스럽게 "엄마가 말씀하신 게 있어"라고 하며 리마인더를 전달합니다
- 리마인더는 한 번 전달되면 자동으로 삭제됩니다
- `/reminder` 명령어만 입력하면 현재 설정된 리마인더를 확인할 수 있습니다
- `/reminder clear`로 리마인더를 삭제할 수 있습니다

## 사용시간 제한 기능

- 아이가 대화할 때마다 사용시간이 추적됩니다
- 설정된 시간을 초과하면 자동으로 대화가 종료됩니다
- 매일 자정에 사용시간이 자동으로 리셋됩니다
- 부모님이 텔레그램에서 실시간으로 시간을 조절할 수 있습니다

## 주의사항

- 마이크 권한이 필요합니다.
- 텔레그램 봇 토큰과 채팅 ID는 보안상 안전하게 보관하세요.
- OpenAI API 키가 필요합니다.

## 문제 해결

### 1. 접근성 권한 오류
```
This process is not trusted! Input event monitoring will not be possible
```
**해결 방법:**
1. 시스템 환경설정 > 보안 및 개인정보 보호 > 접근성으로 이동
2. 터미널 또는 Python을 허용 목록에 추가
3. 프로그램을 다시 실행

### 2. 텔레그램 봇 충돌 오류
```
Conflict: terminated by other getUpdates request
```
**해결 방법:**
1. 기존 실행 중인 프로그램 종료: `pkill -f "python.*main.py"`
2. 프로그램을 다시 실행

### 3. 키보드 리스너가 작동하지 않는 경우
- 접근성 권한이 없어도 프로그램은 계속 실행됩니다
- 이 경우 5초간 고정 녹음으로 작동합니다

### 4. 텔레그램 네트워크 타임아웃 오류
```
telegram.error.TimedOut: Timed out
httpx.ConnectTimeout
```
**해결 방법:**
- 네트워크 연결을 확인하세요
- 프로그램이 자동으로 재시도합니다 (최대 3회)
- 텔레그램 서버가 불안정할 때 발생할 수 있습니다
- 오류가 발생해도 메시지는 정상적으로 처리됩니다

### 5. 오디오 입력 스트림 오류
```
Error opening InputStream: Internal PortAudio error
PaMacCore (AUHAL) Error
```
**해결 방법:**
1. **마이크 권한 확인**:
   - 시스템 환경설정 > 보안 및 개인정보 보호 > 마이크
   - 터미널 또는 Python을 허용 목록에 추가

2. **오디오 장치 확인**:
   - 시스템 환경설정 > 사운드 > 입력
   - 마이크가 올바르게 연결되어 있는지 확인

3. **다른 오디오 앱 종료**:
   - 다른 앱에서 마이크를 사용 중인지 확인
   - Zoom, Discord 등이 마이크를 점유하고 있을 수 있음

4. **시스템 재시작**:
   - 오디오 시스템 문제 시 macOS 재시작

### 6. 텔레그램 연결 풀 타임아웃 오류
```
telegram.error.TimedOut: Pool timeout
httpcore.PoolTimeout
```
**해결 방법:**
- 네트워크 연결을 확인하세요
- 프로그램이 자동으로 재시도합니다 (최대 3회)
- 텔레그램 서버가 불안정할 때 발생할 수 있습니다
- 오류가 발생해도 메시지는 정상적으로 처리됩니다
